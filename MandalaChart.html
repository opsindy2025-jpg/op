<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>文青曼陀羅終極版＋可刪除</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  :root{--bg:#faf8f5;--card:#fffdf9;--text:#5d5d5d;--accent:#b8a89f;--shadow:rgba(180,160,140,0.18);}
  body.dark{--bg:#1a1a1a;--card:#252525;--text:#e8e8e8;--accent:#d8c9c0;--shadow:rgba(0,0,0,0.5);}
  body{margin:0;padding:20px 20px 100px;background:var(--bg);color:var(--text);
       font-family:"Noto Sans TC",sans-serif;transition:all .4s;}
  h1,h2{text-align:center;color:var(--accent);}
  .toolbar{position:fixed;bottom:15px;left:50%;transform:translateX(-50%);
           background:var(--card);padding:12px 20px;border-radius:50px;
           box-shadow:0 10px 30px var(--shadow);z-index:999;display:flex;gap:12px;}
  .btn{padding:10px 18px;background:var(--accent);color:#fff;border:none;
       border-radius:30px;cursor:pointer;font-size:14px;}
  .btn:hover{filter:brightness(1.15);}
  .add-btn{display:block;margin:30px auto;padding:14px 40px;background:var(--accent);
           color:#fff;border:none;border-radius:50px;cursor:pointer;}
  .mandala-set{position:relative;max-width:1100px;margin:70px auto;background:var(--card);
               padding:40px;border-radius:28px;box-shadow:0 20px 50px var(--shadow);}
  /* 刪除按鈕 */
  .delete-btn{position:absolute;top:12px;right:12px;width:36px;height:36px;
              background:#e85d75;color:#fff;border:none;border-radius:50%;
              font-size:20px;line-height:36px;cursor:pointer;opacity:0.7;}
  .delete-btn:hover{opacity:1;transform:scale(1.1);}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-top:30px;}
  .cell{background:var(--card);border-radius:20px;padding:24px;min-height:140px;
        position:relative;box-shadow:0 6px 20px var(--shadow);transition:all .3s;}
  .cell:hover{transform:translateY(-8px);}
  .label{position:absolute;top:10px;left:12px;font-weight:600;color:var(--accent);}
  .center{background:linear-gradient(135deg,#f5e8e1,#e8f0f5);color:#8b7a6e;font-weight:600;}
  .dark .center{background:linear-gradient(135deg,#3a2f2f,#2f3a4a);}
  .subgrid{margin-top:16px;text-align:left;padding-left:20px;font-size:0.92em;}
  .subgrid div{margin:6px 0;padding:4px 8px;border-radius:8px;}
  .subgrid div:focus{background:rgba(216,201,192,0.2);}
  [contenteditable]:focus{outline:2px solid var(--accent);}
</style>
</head>
<body>

<h1>曼陀羅思考法</h1>
<h2>文青終極版 · 可刪除＋自動儲存＋PNG＋Excel</h2>

<button class="add-btn" onclick="addNewMandala()">＋ 新增一組曼陀羅</button>

<div class="toolbar">
  <button class="btn" onclick="toggleDark()">深色模式</button>
  <button class="btn" onclick="saveAll()">儲存</button>
  <button class="btn" onclick="exportPNG()">匯出 PNG</button>
  <button class="btn" onclick="exportExcel()">匯出 Excel</button>
</div>

<script>
// === 自動儲存與載入 ===
function saveAll(){
  localStorage.setItem('mandalaData',document.documentElement.outerHTML);
  alert('已儲存到這台裝置！');
}
function loadAll(){
  const data = localStorage.getItem('mandalaData');
  if(data && confirm('偵測到上次儲存的內容，是否載入？')){
    document.documentElement.innerHTML = data;
    location.reload();
  }
}
window.onload = ()=>{ loadAll(); }

// === 深色模式 ===
function toggleDark(){
  document.body.classList.toggle('dark');
  localStorage.setItem('darkMode',document.body.classList.contains('dark'));
}
if(localStorage.getItem('darkMode')==='true') document.body.classList.add('dark');

// === 匯出 PNG ===
async function exportPNG(){
  const sets = document.querySelectorAll('.mandala-set');
  for(let i=0;i<sets.length;i++){
    const canvas = await html2canvas(sets[i],{scale:2,backgroundColor:null});
    const link = document.createElement('a');
    link.download = (sets[i].querySelector('input').value||'曼陀羅'+(i+1))+'.png';
    link.href = canvas.toDataURL();
    link.click();
    await new Promise(r=>setTimeout(r,300)); // 避免同時下載太多
  }
}

// === 匯出 Excel ===
function exportExcel(){
  const wb = XLSX.utils.book_new();
  document.querySelectorAll('.mandala-set').forEach((set,i)=>{
    const title = set.querySelector('input').value || '曼陀羅'+(i+1);
    const data = [['位置','主標題','1','2','3','4','5','6','7','8']];
    set.querySelectorAll('.cell').forEach(cell=>{
      const label = cell.querySelector('.label')?.textContent || '';
      if(!label) return;
      const main = cell.querySelector('[contenteditable]:not(.subgrid *)')?.innerText || '';
      const subs = Array.from(cell.querySelectorAll('.subgrid div')).map(d=>d.innerText||'');
      data.push([label,main,...subs.slice(0,8)]);
    });
    const ws = XLSX.utils.aoa_to_sheet(data);
    XLSX.utils.book_append_sheet(wb, ws, title.slice(0,31));
  });
  XLSX.writeFile(wb, '曼陀羅計畫表_'+new Date().toISOString().slice(0,10)+'.xlsx');
}

// === 新增一組（空白）===
function addNewMandala(){
  const html = `<div class="mandala-set">
    <button class="delete-btn" onclick="this.parentElement.remove();saveAll()">×</button>
    <input type="text" placeholder="請輸入主標題" style="width:100%;text-align:center;font-size:1.9em;border:none;background:transparent;color:var(--accent);">
    <input type="text" placeholder="副標題（可留空）" style="width:100%;text-align:center;font-size:1.2em;border:none;background:transparent;color:#a89b92;margin-bottom:20px;">
    <div class="grid">
      ${['H','B','C','G','A','D','F','E'].map((label,idx)=>{
        const isCenter = label==='A';
        return `<div class="cell ${isCenter?'center':''}" data-label="${label}">
          <div class="label">${label}</div>
          <div contenteditable="true">${isCenter?'我的大目標':''}</div>
          ${!isCenter ? '<div class="subgrid">'+'<div contenteditable="true"></div>'.repeat(8)+'</div>' : ''}
        </div>`;
      }).join('')}
      <div class="cell"></div>
    </div>
  </div>`;
  document.body.insertAdjacentHTML('beforeend',html);
  window.scrollTo(0,document.body.scrollHeight);
}

// === 初始範例（如果沒有儲存過就建立第一組）===
if(!localStorage.getItem('mandalaData')){
  addNewMandala();
  document.querySelector('input').value = '2025 模板被動收入 500 萬';
  document.querySelectorAll('input')[1].value = '躺著賺錢的自由人生';
  // 這裡可以再填入其他範例內容，省略...
}
</script>
</body>
</html>