<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>2025 超級曼陀羅 - 多頁分類宇宙計畫 (計畫版)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
<style>
  :root{--bg:#faf8f5;--card:#fffdf9;--text:#5d5d5d;--accent:#b8a89f;--shadow:rgba(180,160,140,0.18);--project-color:#6c757d;}
  body.dark{--bg:#1a1a1a;--card:#252525;--text:#e8e8e8;--accent:#d8c9c0;--shadow:rgba(0,0,0,0.5);--project-color:#ced4da;}
  body{margin:0;padding:20px 20px 160px;background:var(--bg);color:var(--text);
       font-family:"Noto Sans TC",sans-serif;overflow-x:auto;overflow-y:auto;min-height:100vh;}
  h1{text-align:center;color:var(--accent);font-size:2.6em;margin:20px 0 10px;}

  /* ------------------- [修改] 標籤列結構 ------------------- */
  .tabs{
    display:flex;flex-direction:column;gap:15px;justify-content:center;margin:30px 0 50px;
    padding:0 0px; /* 移除左右 padding */
    max-width:100%;
  }
  .project-group{
    padding:10px 0;border:1px solid rgba(0,0,0,0.05);border-radius:12px;
    background:rgba(255,255,255,0.8);box-shadow:0 8px 25px var(--shadow);
    max-width:1000px;margin:0 auto;
    width: 100%; /* 確保在手機上撐滿寬度 */
  }
  .dark .project-group{background:rgba(0,0,0,0.2);}
  .project-name{
    display:flex;align-items:center;justify-content:center;
    padding:5px 20px;font-size:1.3em;font-weight:700;color:var(--project-color);
    cursor:move; 
  }
  .project-name:hover{color:var(--accent);}

  /* [關鍵修改] 讓分頁列表橫向捲動 */
  .tab-list{
    display:flex; /* 保持 flex */
    flex-wrap: nowrap; /* 確保不換行，強制橫向 */
    gap:10px;
    justify-content: flex-start; /* 左對齊 */
    padding:10px 20px;
    overflow-x: auto; /* 允許橫向捲動 */
    -webkit-overflow-scrolling: touch; /* iOS 流暢捲動 */
    scrollbar-width: none; /* Firefox 隱藏捲軸 */
  }
  .tab-list::-webkit-scrollbar {
    display: none; /* Chrome/Safari 隱藏捲軸 */
  }
  /* ------------------- [修改結束] ------------------- */

  .tab{
    padding:10px 20px;background:var(--card);color:var(--text);border:2px solid transparent;
    border-radius:30px;cursor:move;
    font-weight:500;box-shadow:0 4px 12px var(--shadow);
    transition:all .3s;min-width:100px;text-align:center;flex-shrink:0; /* 確保分頁不被擠壓 */
  }
  .tab.active{background:var(--accent);color:#fff;transform:scale(1.05);cursor:default;}
  .tab:hover:not(.active){background:rgba(184,168,159,0.2);}
  .tab.add-tab-project{
    background:#4caf50 !important;color:#fff !important;cursor:pointer;
    padding:10px 20px;font-weight:600;
  }
  .project-name .edit-project-btn{
    margin-left:10px;cursor:pointer;font-size:0.8em;color:var(--accent);opacity:0.6;
    transition:opacity .2s;
  }
  .project-name .edit-project-btn:hover{opacity:1;}
  .add-project-btn{
    margin:15px auto 0;
    padding:10px 20px;background:#2196f3 !important;color:#fff !important;border-radius:30px;
    cursor:pointer;font-weight:600;box-shadow:0 4px 12px var(--shadow);
  }

  /* 其餘樣式保持不變 */
  .super-mandala{display:none;width:1480px;margin:0 auto 120px;padding:40px;background:var(--card);
    border-radius:32px;box-shadow:0 30px 80px var(--shadow);position:relative;}
  .super-mandala.active{display:block;}
  .delete-super{position:absolute;top:16px;right:16px;width:44px;height:44px;
    background:#e85d75;color:#fff;border:none;border-radius:50%;font-size:26px;cursor:pointer;z-index:10;}
  .big-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:32px;}
  .big-cell{background:linear-gradient(135deg,#f9f5f2,#f0f8ff);border-radius:28px;padding:24px;
    box-shadow:0 12px 40px var(--shadow);}
  .dark .big-cell{background:linear-gradient(135deg,#2a2426,#1e2a38);}
  .big-title{text-align:center;font-size:1.5em;font-weight:700;color:var(--accent);
    margin-bottom:16px;padding:8px;background:rgba(184,168,159,0.15);border-radius:16px;}
  .center-big{background:linear-gradient(135deg,#ffe8e1,#e1f0ff)!important;
    font-size:2.2em!important;color:#8b6f5e;display:flex;align-items:center;justify-content:center;
    text-align:center;line-height:1.4;padding:40px!important;}
  .dark .center-big{background:linear-gradient(135deg,#3f2f38,#2f3a4a)!important;color:#f0d8c0;}
  .mini-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:12px;}
  .mini-cell{background:rgba(255,255,255,0.75);border-radius:12px;padding:12px 10px;
    font-size:0.92em;line-height:1.5;min-height:68px;box-shadow:0 4px 12px rgba(0,0,0,0.08);
    transition:all .3s;}
  .dark .mini-cell{background:rgba(0,0,0,0.4);}
  .mini-cell:hover{transform:translateY(-4px);}
  .mini-center{background:linear-gradient(135deg,#ffe0d8,#d8e8ff)!important;
    font-weight:700;font-size:1.1em!important;}
  .dark .mini-center{background:linear-gradient(135deg,#4a2f3a,#2f3a4a)!important;color:#f0d8c0;}
  .toolbar{position:fixed;bottom:12px;left:50%;transform:translateX(-50%);
    background:var(--card);padding:12px 22px;border-radius:50px;
    box-shadow:0 12px 40px var(--shadow);z-index:999;display:flex;gap:14px;}
  .btn{padding:12px 24px;background:var(--accent);color:#fff;border:none;
       border-radius:30px;cursor:pointer;font-size:15px;}
  [contenteditable]:focus{outline:2px solid var(--accent);background:rgba(184,168,159,0.15);}
  .super-mandala input[type="text"]:first-of-type{ /* 確保標題輸入框與分頁名稱同步 */
      width:100%;text-align:center;font-size:2.3em;border:none;background:transparent;
      color:var(--accent);font-weight:700;margin-bottom:10px;
  }

  /* 彈窗樣式 */
  .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);
    display:none;align-items:center;justify-content:center;z-index:1000;}
  .modal-content{background:var(--card);padding:30px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.3);
    width:90%;max-width:400px;text-align:center;}
  .modal-content h3{color:var(--accent);margin-top:0;}
  .modal-content label{display:block;text-align:left;margin-bottom:5px;font-weight:600;}
  .modal-content select, .modal-content input[type="text"]{
    width:100%;padding:10px;margin-bottom:15px;border:1px solid var(--accent);
    border-radius:8px;box-sizing:border-box;background:var(--bg);color:var(--text);
  }
  .modal-actions{display:flex;justify-content:space-around;margin-top:20px;}
  .modal-actions button{flex-grow:1;margin:0 5px;padding:10px;border-radius:8px;font-weight:600;}
  .modal-actions .confirm-btn{background:#4CAF50;color:white;border:none;}
  .modal-actions .cancel-btn{background:#e85d75;color:white;border:none;}
</style>
</head>
<body>

<h1>2025 超級曼陀羅 - 多頁分類宇宙計畫 (計畫版)</h1>

<div class="tabs" id="project-list">
  </div>
<div class="tabs">
    <div class="tab add-project-btn" onclick="addNewProject()">＋ 新增計畫</div>
</div>

<div id="mandala-content-container">
  <div id="tab1" class="super-mandala active" data-project-id="project1">
    <button class="delete-super">×</button>
    <input type="text" value="2025 模板被動收入 500 萬 - 宇宙版" data-tab-title="true">
    <input type="text" value="躺著也能財富自由（81 格全開！）" style="width:100%;text-align:center;font-size:1.4em;border:none;background:transparent;color:#a89b92;">

    <div class="big-grid">
      <div class="big-cell"><div class="big-title" contenteditable>里程碑與生活平衡</div><div class="mini-grid">
        <div class="mini-cell" contenteditable>Q1 20萬</div><div class="mini-cell" contenteditable>Q2 50萬</div><div class="mini-cell" contenteditable>Q3 80萬</div>
        <div class="mini-cell" contenteditable>Q4 100萬+</div><div class="mini-cell mini-center" contenteditable>每天只工作 4-5 小時</div>
        <div class="mini-cell" contenteditable>每週 3 天完全離線</div><div class="mini-cell" contenteditable>每季出國一個月</div><div class="mini-cell" contenteditable>2025/12/31 慶功</div><div class="mini-cell" contenteditable>備用</div>
      </div></div>
      <div class="big-cell"><div class="big-title" contenteditable>產品線規劃</div><div class="mini-grid">
        <div class="mini-cell" contenteditable>Next.js 企業官網</div><div class="mini-cell" contenteditable>Framer 高轉換 LP</div><div class="mini-cell" contenteditable>SaaS 完整網站</div>
        <div class="mini-cell" contenteditable>電商模板</div><div class="mini-cell mini-center" contenteditable>每月推 2 個付費模板</div>
        <div class="mini-cell" contenteditable>Notion 系統</div><div class="mini-cell" contenteditable>3D 沉浸式作品集</div><div class="mini-cell" contenteditable>Shadcn 套件</div><div class="mini-cell" contenteditable>Webflow 模板</div>
      </div></div>
      <div class="big-cell"><div class="big-title" contenteditable>銷售平台與通路</div><div class="mini-grid">
        <div class="mini-cell" contenteditable>Gumroad 主戰場</div><div class="mini-cell" contenteditable>Lemon Squeezy</div><div class="mini-cell" contenteditable>自架網站</div>
        <div class="mini-cell" contenteditable>Envato</div><div class="mini-cell mini-center" contenteditable>聯盟行銷 30-50%</div>
        <div class="mini-cell" contenteditable>小紅書數位店</div><div class="mini-cell" contenteditable>微信視頻號</div><div class="mini-cell" contenteditable>X 直達車</div><div class="mini-cell" contenteditable>備用平台</div>
      </div></div>
      <div class="big-cell"><div class="big-title" contenteditable>自動化與團隊</div><div class="mini-grid">
        <div class="mini-cell" contenteditable>ChatGPT 客服</div><div class="mini-cell" contenteditable>影片剪輯外包</div><div class="mini-cell" contenteditable>設計外包</div>
        <div class="mini-cell" contenteditable>自動報表</div><div class="mini-cell mini-center" contenteditable>年底招全職助手</div>
        <div class="mini-cell" contenteditable>SOP 完整化</div><div class="mini-cell" contenteditable>稅務自動化</div><div class="mini-cell" contenteditable>聯盟追蹤</div><div class="mini-cell" contenteditable>備用</div>
      </div></div>
      <div class="big-cell center-big">
        <div contenteditable>2025 年<br>純模板被動收入<br>500 萬</div>
      </div>
      <div class="big-cell"><div class="big-title" contenteditable>價格與收入結構</div><div class="mini-grid">
        <div class="mini-cell" contenteditable>高階 $199-$499</div><div class="mini-cell" contenteditable>中階 $79-$149</div><div class="mini-cell" contenteditable>Notion $29-$79</div>
        <div class="mini-cell" contenteditable>訂閱 $39/月</div><div class="mini-cell mini-center" contenteditable>終身會員 $999</div>
        <div class="mini-cell" contenteditable>企業授權 $1999+</div><div class="mini-cell" contenteditable>Bundle $299-$599</div>
        <div class="mini-cell" contenteditable>聯盟分潤 80-100萬</div><div class="mini-cell" contenteditable>備用</div>
      </div></div>
      <div class="big-cell"><div class="big-title" contenteditable>內容行銷引擎</div><div class="mini-grid">
        <div class="mini-cell" contenteditable>每週 1 支 YouTube</div><div class="mini-cell" contenteditable>每天 2-3 X 貼文</div><div class="mini-cell" contenteditable>每月免費模板換 Email</div>
        <div class="mini-cell" contenteditable>小紅書 15 篇爆款</div><div class="mini-cell mini-center" contenteditable>建 5 萬人名單</div>
        <div class="mini-cell" contenteditable>50 篇 SEO 文</div><div class="mini-cell" contenteditable>每月直播教學</div>
        <div class="mini-cell" contenteditable>30 個 Podcast</div><div class="mini-cell" contenteditable>備用</div>
      </div></div>
      <div class="big-cell"><div class="big-title" contenteditable>產品開發流程</div><div class="mini-grid">
        <div class="mini-cell" contenteditable>V0 + Cursor + Claude</div><div class="mini-cell" contenteditable>每支 ≤7 天完成</div><div class="mini-cell" contenteditable>自建 Component Library</div>
        <div class="mini-cell" contenteditable>3 種風格變體</div><div class="mini-cell mini-center" contenteditable>附 30-60 分鐘教學影片</div>
        <div class="mini-cell" contenteditable>Figma + Notion 手冊</div><div class="mini-cell" contenteditable>90 天退款</div>
        <div class="mini-cell" contenteditable>終身更新</div><div class="mini-cell" contenteditable>備用</div>
      </div></div>
      <div class="big-cell"><div class="big-title" contenteditable>未來擴展</div><div class="mini-grid">
        <div class="mini-cell" contenteditable>開設模板學校</div><div class="mini-cell" contenteditable>推出英文版</div><div class="mini-cell" contenteditable>Gumroad Top 100</div>
        <div class="mini-cell" contenteditable>進軍企業市場</div><div class="mini-cell mini-center" contenteditable>更多瘋狂想法…</div>
        <div class="mini-cell" contenteditable></div><div class="mini-cell" contenteditable></div><div class="mini-cell" contenteditable></div><div class="mini-cell" contenteditable></div>
      </div></div>
    </div>
  </div>
</div>

<div class="toolbar">
  <button class="btn" onclick="toggleDark()">深色</button>
  <button class="btn" onclick="saveAll()">儲存</button>
  <button class="btn" onclick="addNewTabFromToolbar()">新增分頁</button>   <button class="btn" onclick="exportPNG()">匯出 PNG</button>
  <button class="btn" onclick="exportExcel()">匯出 Excel</button>
  
</div>

<div id="addNewTabModal" class="modal-overlay" onclick="closeModalIfOutside(event)">
  <div class="modal-content">
    <h3 id="modalTitle">新增分頁 (曼陀羅)</h3>
    <input type="hidden" id="modalTargetProjectId">

    <label for="newTabNameInput">分頁名稱：</label>
    <input type="text" id="newTabNameInput" placeholder="請輸入分頁名稱" value="新分頁">

    <div class="modal-actions">
      <button class="confirm-btn" onclick="confirmAddNewTabFromModal()">確定新增</button>
      <button class="cancel-btn" onclick="document.getElementById('addNewTabModal').style.display='none'">取消</button>
    </div>
  </div>
</div>

<div id="editProjectModal" class="modal-overlay" onclick="closeModalIfOutside(event)">
  <div class="modal-content">
    <h3>編輯計畫</h3>
    <input type="hidden" id="editingProjectId">
    <label for="editProjectName">計畫名稱：</label>
    <input type="text" id="editProjectName" placeholder="請輸入計畫名稱">

    <div class="modal-actions">
      <button class="confirm-btn" onclick="confirmEditProject()">儲存修改</button>
      <button class="cancel-btn" onclick="deleteProject()">刪除計畫 (含所有分頁)</button>
    </div>
    <p style="font-size:0.9em;color:var(--project-color);margin-top:15px;">刪除計畫將同時刪除其下的所有分頁</p>
  </div>
</div>


<script>
let projectData = {};
let nextTabId = 2;
let nextProjectId = 2;

window.onload = () => {
  const saved = localStorage.getItem('mandalaData');
  const savedProjects = localStorage.getItem('projectData');
  
  if (saved && savedProjects && confirm('偵測到上次儲存，是否載入？\n\n確定 → 載入所有計畫與分頁\n取消 → 全部重置為預設')) {
    document.getElementById('mandala-content-container').innerHTML = saved;
    projectData = JSON.parse(savedProjects);
    nextTabId = Math.max(...document.querySelectorAll('.super-mandala').length > 0 ? Array.from(document.querySelectorAll('.super-mandala')).map(el => parseInt(el.id.replace('tab', ''))) : [0]) + 1;
    nextProjectId = Math.max(...Object.keys(projectData).map(key => parseInt(key.replace('project', '')))) + 1;
  } else {
    localStorage.removeItem('mandalaData');
    projectData = {
      'project1': {
        name: '財務與業務',
        tabs: [
          { id: 'tab1', name: '財富自由' },
        ]
      }
    };
    localStorage.setItem('projectData', JSON.stringify(projectData));
  }

  if(localStorage.getItem('darkMode')==='true') document.body.classList.add('dark');
  renderTabs();
  bindAllEvents();
};

function closeModalIfOutside(event) {
    if (event.target.classList.contains('modal-overlay')) {
        event.target.style.display = 'none';
    }
}

function renderTabs() {
  const tabsContainer = document.getElementById('project-list');
  tabsContainer.innerHTML = '';
  let firstTabClicked = false;
  const activeTabId = document.querySelector('.super-mandala.active')?.id || 'tab1';

  for (const projectId in projectData) {
    const project = projectData[projectId];
    const projectGroup = document.createElement('div');
    projectGroup.className = 'project-group';
    projectGroup.setAttribute('data-project-id', projectId);

    projectGroup.innerHTML = `
      <div class="project-name">
        ${project.name}
        <span class="edit-project-btn" onclick="event.stopPropagation(); showEditProjectModal('${projectId}')">⚙️ 編輯</span>
      </div>
      <div class="tab-list" id="tab-list-${projectId}"></div>
    `;
    tabsContainer.appendChild(projectGroup);

    const tabList = projectGroup.querySelector('.tab-list');
    
    // 從 DOM 讀取最新的標題，同步到 projectData 和 tabElement
    project.tabs.forEach((tab) => {
      const mandalaPage = document.getElementById(tab.id);
      const currentTitle = mandalaPage?.querySelector('input[data-tab-title="true"]')?.value || tab.name;
      tab.name = currentTitle;
      
      const tabElement = document.createElement('div');
      tabElement.className = 'tab';
      tabElement.setAttribute('data-tab', tab.id);
      tabElement.setAttribute('data-project-id', projectId);
      tabElement.textContent = currentTitle;
      tabList.appendChild(tabElement);
      
      if (tab.id === activeTabId && document.getElementById(tab.id)) {
        tabElement.classList.add('active');
        document.getElementById(tab.id).classList.add('active');
        firstTabClicked = true;
      }
    });

    const addTabButton = document.createElement('div');
    addTabButton.className = 'tab add-tab-project'; 
    addTabButton.textContent = '＋ 新增分頁';
    addTabButton.onclick = function(e) { 
        e.stopPropagation(); 
        // 帶入當前活躍的分頁 ID，以便知道新分頁要插在哪裡
        const activeTab = document.querySelector('.super-mandala.active');
        showAddNewTabModal(projectId, project.name, activeTab?.id); 
    };
    tabList.appendChild(addTabButton);
  }
  
  // 確保至少有一個分頁是活躍的
  if (!firstTabClicked && document.querySelector('.super-mandala')) {
      document.querySelector('.super-mandala').classList.add('active');
      document.querySelector('.tab').classList.add('active');
  }

  bindAllEvents();
  setupSortable();
}

function setupSortable() {
    // 1. 計畫排序 (Project Sort)
    new Sortable(document.getElementById('project-list'), {
        animation: 150,
        handle: '.project-name',
        draggable: '.project-group',
        delay: 50, 
        touchStartThreshold: 5,
        onEnd: function (evt) {
            const newProjectOrder = Array.from(evt.to.children).map(el => el.getAttribute('data-project-id'));
            const newProjectData = {};
            newProjectOrder.forEach(id => {
                if (projectData[id]) {
                    newProjectData[id] = projectData[id];
                }
            });
            projectData = newProjectData;
            saveAll();
        },
    });

    // 2. 分頁排序 (Tab Sort)
    document.querySelectorAll('.tab-list').forEach(tabList => {
        new Sortable(tabList, {
            group: 'tabs',
            animation: 150,
            draggable: '.tab:not(.add-tab-project)', // 排除新增按鈕
            filter: '.add-tab-project', 
            delay: 50, 
            touchStartThreshold: 5,
            onEnd: function (evt) {
                const sourceProjectId = evt.from.id.replace('tab-list-', '');
                const targetProjectId = evt.to.id.replace('tab-list-', '');
                const tabId = evt.item.getAttribute('data-tab');
                
                const tabToMove = projectData[sourceProjectId].tabs.find(t => t.id === tabId);
                
                // 1. 更新 projectData 結構
                if (sourceProjectId !== targetProjectId) {
                    // 跨計畫拖曳：從來源移除
                    projectData[sourceProjectId].tabs = projectData[sourceProjectId].tabs.filter(t => t.id !== tabId);
                }
                
                // 整理目標計畫的新順序
                const targetTabsOrder = Array.from(evt.to.children)
                    .filter(el => el.classList.contains('tab') && !el.classList.contains('add-tab-project'))
                    .map(el => el.getAttribute('data-tab'));
                
                // 建立新的 target.tabs 陣列
                const allTargetTabs = (projectData[targetProjectId].tabs || []).concat(sourceProjectId !== targetProjectId ? [tabToMove] : [] );
                
                projectData[targetProjectId].tabs = targetTabsOrder.map(id => 
                    allTargetTabs.find(t => t.id === id) || (id === tabId ? tabToMove : null)
                ).filter(t => t !== null);

                // 2. 更新 DOM 上的 project-id 屬性
                document.getElementById(tabId)?.setAttribute('data-project-id', targetProjectId);
                evt.item.setAttribute('data-project-id', targetProjectId);
                
                saveAll();
            },
        });
    });
}

function bindTitleSync() {
  document.querySelectorAll('.super-mandala input[data-tab-title="true"]').forEach(input => {
    // 移除舊的監聽器，避免重複
    input.oninput = null; 
    input.onchange = null;
    
    input.oninput = function() {
      // 實時更新，但避免太頻繁儲存
      const newName = this.value.trim();
      const tabId = this.closest('.super-mandala').id;
      const tabElement = document.querySelector(`.tab[data-tab="${tabId}"]`);
      
      if (newName && tabElement) {
        tabElement.textContent = newName;
        const projectId = tabElement.getAttribute('data-project-id');
        const tabToUpdate = projectData[projectId]?.tabs.find(t => t.id === tabId);
        if (tabToUpdate) {
          tabToUpdate.name = newName;
        }
      }
    };
    
    input.onchange = saveAll; // 在失去焦點時儲存所有資料
  });
}


function bindAllEvents(){
  document.querySelectorAll('.tab:not(.add-tab-project):not(.add-project-btn)').forEach(tab => {
    tab.onclick = function(){
      // 1. 移除所有 active 狀態
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.querySelectorAll('.super-mandala').forEach(m=>m.classList.remove('active'));
      
      // 2. 設定當前 active 狀態
      this.classList.add('active');
      const id = this.getAttribute('data-tab');
      document.getElementById(id)?.classList.add('active');
    };
  });
  rebindDeleteButtons();
  bindTitleSync(); // 呼叫新的標題同步函式
}

/**
 * 顯示新增分頁模態窗 (由 project-group 裡的「新增分頁」按鈕觸發)
 * @param {string} projectId 目標計畫 ID
 * @param {string} projectName 目標計畫名稱
 * @param {string} referenceTabId 目前活躍分頁的 ID (用於插入新分頁的位置)
 */
function showAddNewTabModal(projectId, projectName, referenceTabId) {
    const modal = document.getElementById('addNewTabModal');
    const targetProjectIdInput = document.getElementById('modalTargetProjectId');
    const newTabNameInput = document.getElementById('newTabNameInput');
    const confirmBtn = modal.querySelector('.confirm-btn');

    // 清理可能存在的下拉選單 (從工具列功能帶入的)
    document.getElementById('selectProjectForTab')?.parentElement.remove();
    // 重新綁定回預設的確認函式
    confirmBtn.onclick = confirmAddNewTabFromModal;

    document.getElementById('modalTitle').textContent = `新增分頁到「${projectName}」`;
    targetProjectIdInput.value = `${projectId}|${referenceTabId || ''}`; // 儲存 Project ID 和參考分頁 ID
    newTabNameInput.value = `新計畫分頁 ${nextTabId}`;
    modal.style.display = 'flex';
    newTabNameInput.focus();
}

/**
 * 顯示新增分頁模態窗 (由工具列的「新增分頁」按鈕觸發)
 */
function addNewTabFromToolbar() {
    if (Object.keys(projectData).length === 0) {
        alert('請先點擊「新增計畫」建立一個計畫！');
        return;
    }
    
    // 如果只有一個計畫，直接使用該計畫的 ID
    if (Object.keys(projectData).length === 1) {
        const firstProjectId = Object.keys(projectData)[0];
        const firstProjectName = projectData[firstProjectId].name;
        const activeTab = document.querySelector('.super-mandala.active');
        showAddNewTabModal(firstProjectId, firstProjectName, activeTab?.id);
        return;
    }

    // 如果有多個計畫，需要讓使用者選擇
    const modal = document.getElementById('addNewTabModal');
    const title = document.getElementById('modalTitle');
    const targetProjectIdInput = document.getElementById('modalTargetProjectId');
    const newTabNameInput = document.getElementById('newTabNameInput');
    const confirmBtn = modal.querySelector('.confirm-btn');
    
    // 1. 建立計畫選擇下拉式選單
    let selectHtml = '<div id="projectSelectGroup"><label for="selectProjectForTab">選擇計畫群組：</label><select id="selectProjectForTab">';
    for (const projectId in projectData) {
        selectHtml += `<option value="${projectId}">${projectData[projectId].name}</option>`;
    }
    selectHtml += '</select></div>';
    
    // 2. 更新模態窗內容
    newTabNameInput.insertAdjacentHTML('beforebegin', selectHtml);
    title.textContent = "新增分頁到指定計畫";
    targetProjectIdInput.value = ""; // 清空，表示現在要讀取下拉選單
    newTabNameInput.value = `新計畫分頁 ${nextTabId}`;
    
    // 3. 調整確認按鈕的點擊事件
    confirmBtn.onclick = confirmAddNewTabFromModal_SelectProject;

    modal.style.display = 'flex';
    document.getElementById('selectProjectForTab').focus();
}

/**
 * 確認新增分頁 (從計畫群組內的按鈕或單一計畫的工具列按鈕觸發)
 */
function confirmAddNewTabFromModal(){
    const finalName = document.getElementById('newTabNameInput').value.trim();
    // 讀取 projectID 和 referenceTabId
    const [finalProjectId, referenceTabId] = document.getElementById('modalTargetProjectId').value.split('|');
    
    if(!finalName || !finalProjectId) {
        alert('分頁名稱不能為空。');
        return;
    }
    
    document.getElementById('addNewTabModal').style.display = 'none';
    addNewMandalaPage(finalProjectId, finalName, referenceTabId);
}

/**
 * 確認新增分頁 (從多個計畫的工具列按鈕觸發)
 */
function confirmAddNewTabFromModal_SelectProject() {
    const finalName = document.getElementById('newTabNameInput').value.trim();
    const finalProjectId = document.getElementById('selectProjectForTab')?.value;
    const activeTab = document.querySelector('.super-mandala.active');
    
    if (!finalName || !finalProjectId) {
        alert('分頁名稱或計畫不能為空。');
        return;
    }
    
    // 執行新增操作，並將新分頁放在目前活躍分頁的下方 (如果活躍分頁屬於該計畫)
    addNewMandalaPage(finalProjectId, finalName, activeTab?.id);

    // 重設模態窗回預設狀態
    document.getElementById('projectSelectGroup')?.remove();
    document.getElementById('modalTitle').textContent = "新增分頁 (曼陀羅)";
    document.getElementById('addNewTabModal').querySelector('.confirm-btn').onclick = confirmAddNewTabFromModal; 

    document.getElementById('addNewTabModal').style.display = 'none';
}

/**
 * 實際新增曼陀羅頁面
 * @param {string} finalProjectId 目標計畫 ID
 * @param {string} finalName 新分頁名稱
 * @param {string} referenceTabId 參考分頁 ID (新分頁將插入在其後)
 */
function addNewMandalaPage(finalProjectId, finalName, referenceTabId) {
  const newId = 'tab' + nextTabId++;
  const projectTabs = projectData[finalProjectId]?.tabs || [];
  let insertIndex = projectTabs.length;

  const newTabObject = { id: newId, name: finalName };
  
  // 1. 計算插入點 (如果 referenceTabId 存在且屬於目標計畫)
  if (referenceTabId && document.getElementById(referenceTabId)?.getAttribute('data-project-id') === finalProjectId) {
    const refIndex = projectTabs.findIndex(t => t.id === referenceTabId);
    if (refIndex !== -1) {
      insertIndex = refIndex + 1;
    }
  }
  
  projectTabs.splice(insertIndex, 0, newTabObject);


  // 2. 建立新的曼陀羅頁面 DOM
  const page = document.createElement('div');
  page.id = newId;
  page.className = 'super-mandala';
  page.setAttribute('data-project-id', finalProjectId); 
  page.innerHTML = `
    <button class="delete-super">×</button>
    <input type="text" value="${finalName}" data-tab-title="true">
    <input type="text" value="副標題（可留空）" style="width:100%;text-align:center;font-size:1.4em;border:none;background:transparent;color:#a89b92;">
    <div class="big-grid">
      ${Array.from({length:9},(_,i)=> i===4 ? `
        <div class="big-cell center-big"><div contenteditable>2025<br>核心目標</div></div>` : `
        <div class="big-cell">
          <div class="big-title" contenteditable>大標題</div>
          <div class="mini-grid">
            ${Array(9).fill().map((_,j)=>`<div class="mini-cell${j===4?' mini-center':''}" contenteditable></div>`).join('')}
          </div>
        </div>`
      ).join('')}
    </div>`;

  // 3. 插入 DOM
  const container = document.getElementById('mandala-content-container');
  const referencePage = document.getElementById(referenceTabId);
  
  if (referencePage && referencePage.nextElementSibling) {
    container.insertBefore(page, referencePage.nextElementSibling);
  } else {
    container.appendChild(page);
  }
  
  // 4. 重新渲染 Tab 列並切換到新分頁
  renderTabs();
  
  const newTabElement = document.querySelector(`.tab[data-tab="${newId}"]`);
  if (newTabElement) {
    newTabElement.click();
    // 確保標題同步功能也作用在新元素上
    bindTitleSync(); 
  }
  
  saveAll();
}

function addNewProject(){
    const name = prompt('請輸入新計畫名稱：', '新計畫 ' + nextProjectId);
    if(!name) return;
    
    const newProjectId = 'project' + nextProjectId++;
    projectData[newProjectId] = {
        name: name,
        tabs: []
    };
    renderTabs();
    saveAll();
}

function showEditProjectModal(projectId){
    const project = projectData[projectId];
    document.getElementById('editingProjectId').value = projectId;
    document.getElementById('editProjectName').value = project.name;
    document.getElementById('editProjectModal').style.display = 'flex';
}

function confirmEditProject(){
    const projectId = document.getElementById('editingProjectId').value;
    const newName = document.getElementById('editProjectName').value.trim();
    
    if(newName){
        projectData[projectId].name = newName;
        renderTabs();
        document.getElementById('editProjectModal').style.display = 'none';
        saveAll();
    } else {
        alert('計畫名稱不能為空');
    }
}

function deleteProject(){
    if(!confirm('確定要刪除此計畫及其下的所有分頁嗎？')) return;
    
    const projectId = document.getElementById('editingProjectId').value;
    const tabsToDelete = projectData[projectId].tabs.map(t => t.id);
    
    tabsToDelete.forEach(id => {
        document.getElementById(id)?.remove();
    });
    
    delete projectData[projectId];
    
    renderTabs();
    document.getElementById('editProjectModal').style.display = 'none';

    document.querySelector('.tab')?.click();
    
    saveAll();
}

function rebindDeleteButtons(){
  document.querySelectorAll('.delete-super').forEach(b=>b.onclick=function(){
    if(confirm('確定刪除這整頁？')){
      const id = this.parentElement.id; 
      const projectId = this.parentElement.getAttribute('data-project-id'); 
      
      document.getElementById(id).remove();
      
      if(projectData[projectId]){
        projectData[projectId].tabs = projectData[projectId].tabs.filter(t => t.id !== id);
      }
      
      renderTabs();
      
      document.querySelector('.tab')?.click();

      saveAll();
    }
  });
}

// 移除 renameCurrentTab 函式

function saveAll(){ 
  // 在儲存前，確保所有標題都是最新的
  document.querySelectorAll('.super-mandala input[data-tab-title="true"]').forEach(input => {
      const tabId = input.closest('.super-mandala').id;
      const projectId = input.closest('.super-mandala').getAttribute('data-project-id');
      const newName = input.value.trim();
      const tabToUpdate = projectData[projectId]?.tabs.find(t => t.id === tabId);
      if (tabToUpdate) {
        tabToUpdate.name = newName;
      }
  });
  
  localStorage.setItem('mandalaData', document.getElementById('mandala-content-container').innerHTML);
  localStorage.setItem('projectData', JSON.stringify(projectData)); 
}
function toggleDark(){
  document.body.classList.toggle('dark');
  localStorage.setItem('darkMode', document.body.classList.contains('dark'));
}
async function exportPNG(){
  for(let page of document.querySelectorAll('.super-mandala')){
    // 隱藏刪除按鈕，避免匯出時顯示
    const deleteBtn = page.querySelector('.delete-super');
    if(deleteBtn) deleteBtn.style.display = 'none';

    const c = await html2canvas(page,{scale:1.8});
    const a = document.createElement('a');
    a.download = (page.querySelector('input[data-tab-title="true"]')?.value||'曼陀羅')+'.png';
    a.href = c.toDataURL(); a.click();
    
    if(deleteBtn) deleteBtn.style.display = 'block'; // 恢復刪除按鈕
    await new Promise(r=>setTimeout(r,400));
  }
}
function exportExcel(){
  const wb = XLSX.utils.book_new();
  document.querySelectorAll('.super-mandala').forEach((p,i)=>{
    const data = [[p.querySelector('input[data-tab-title="true"]')?.value || '分頁'+(i+1)],[]];
    p.querySelectorAll('.big-cell').forEach(b=>{
      const title = b.querySelector('.big-title')?.innerText || b.querySelector('.center-big')?.innerText || '';
      data.push([title]); 
      b.querySelectorAll('.mini-cell').forEach((m,j)=>{ if(j%3===0) data.push([]);
        data[data.length-1].push(m.innerText.trim()||'');
      });
      data.push([]);
    });
    const ws = XLSX.utils.aoa_to_sheet(data);
    ws['!cols'] = Array(3).fill({wch:28});
    XLSX.utils.book_append_sheet(wb, ws, (p.querySelector('input[data-tab-title="true"]')?.value||'分頁'+(i+1)).slice(0,31));
  });
  XLSX.writeFile(wb,'2025全部分頁曼陀羅_'+new Date().toISOString().slice(0,10)+'.xlsx');
}

renderTabs();
</script>
</body>
</html>